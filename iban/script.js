// تضمين خط عربي (Amiri) كـ Base64
const amiriFontBase64 = `application/font-woff;charset=utf-8;base64,d09GRgABAAAAAAeAAA4AAAAACBAAAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAAABWAAAABwAAAAch6L/Z0dERUYAAAF0AAAAHQAAABwAKAAET1MvMgAAAZQAAABJAAAAYLd4QDpjbWFwAAAB1AAAAEUAAAFS1q42g2N2dCAAAAIYAAAABAAAAAQAKAL4Z2FzcAAAAiwAAAAIAAAACP//AANnbHlmAAACMAAAAHUAAACk1Zl/1mhheHAAAACIAAAAHQAAACADuwEfaG1hcAAAAJAAAABIAAAARLcCAABtYXhwAAAAmAAAACAAAAAgAS4B9G5hbWUAAACwAAAA+QAAARO911oUcG9zdAAAASgAAABcAAAAVvqfj1BwcmVwAAABeAAAALgAAAGq72PwVgAAAAEAAAAA8MhiJwAAAACjl6o+AAAAAMFTuJX+c8uIzr0ESuwAAQAAAAAAAAAAAAAAAAAAAIAAAQAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA......`;

let clientAccounts = [];
let prefix = "";
let suffix = "";
let editableLength = 0;

// ملء قائمة الخانات (3 إلى 20)
window.onload = function () {
  const select = document.getElementById("startPosSelect");
  for (let i = 3; i <= 20; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.text = `الخانة ${i}`;
    select.appendChild(option);
  }
  updateEndPosition();
};

// تحديث الخانة النهائية (ابتدائية + 2)
function updateEndPosition() {
  const start = parseInt(document.getElementById("startPosSelect").value);
  const end = start + 2;
  document.getElementById("endPosDisplay").value = end;
  return { start, end };
}

document.getElementById("startPosSelect").addEventListener("change", updateEndPosition);

function startGeneration() {
  const baseIban = document.getElementById("baseIban").value.trim().replace(/\s+/g, "");
  const { start, end } = updateEndPosition();
  const initialCount = parseInt(document.getElementById("initialCount").value);
  const idPattern = document.getElementById("idPattern").value.trim() || "CUST-{000}";

  if (baseIban.length !== 24) {
    alert("رقم IBAN يجب أن يكون 24 حرفًا بالضبط.");
    return;
  }
  if (!baseIban.startsWith("SA")) {
    alert("يجب أن يبدأ IBAN بـ SA");
    return;
  }
  if (start < 3 || end > 22 || start >= end) {
    alert("نطاق الخانات غير صحيح.");
    return;
  }
  if (isNaN(initialCount) || initialCount < 1) {
    alert("الرجاء إدخال عدد صحيح أكبر من 0");
    return;
  }

  const nationalPart = baseIban.substring(2);
  prefix = nationalPart.substring(0, start - 1);
  suffix = nationalPart.substring(end);
  editableLength = end - start + 1;
  const maxValue = Math.pow(10, editableLength);

  const currentStr = nationalPart.substring(start - 1, end);
  let nextValue = parseInt(currentStr, 10) + 1;

  if (nextValue + initialCount - 1 >= maxValue) {
    alert(`لا يمكن توليد ${initialCount} حسابات. تجاوز الحد المسموح.`);
    return;
  }

  clientAccounts = [];
  document.getElementById("step1").classList.add("hidden");
  document.getElementById("step2").classList.remove("hidden");
  document.getElementById("clientsContainer").innerHTML = "";

  for (let i = 0; i < initialCount; i++) {
    const numStr = (nextValue + i).toString().padStart(editableLength, '0');
    const national = prefix + numStr + suffix;
    const iban = "SA" + national;
    const formattedIban = iban.match(/.{1,4}/g).join(" ");
    const autoId = generateId(clientAccounts.length);

    const item = document.createElement("div");
    item.className = "client-item";
    item.innerHTML = `
      <div><small>${formattedIban}</small></div>
      <input type="text" class="client-name" placeholder="اسم العميل">
      <input type="text" class="amount" placeholder="مبلغ العقار (مثل: ١٠٠٠)">
    `;
    document.getElementById("clientsContainer").appendChild(item);

    clientAccounts.push({
      iban: formattedIban,
      national,
      name: "",
      id: autoId,
      amount: ""
    });
  }
}

function generateId(index) {
  const pattern = document.getElementById("idPattern").value || "CUST-{000}";
  const match = pattern.match(/\{(.+?)\}/);
  if (!match) return `ID-${index}`;
  const format = match[1];
  const len = format.length;
  const start = parseInt(format.replace(/\D/g, '')) || 0;
  return pattern.replace(/\{(.+?)\}/, (start + index).toString().padStart(len, '0'));
}

function addNewClient() {
  const { start, end } = updateEndPosition();
  const maxValue = Math.pow(10, editableLength);
  if (clientAccounts.length >= maxValue) {
    alert("تم استهلاك جميع الأرقام الممكنة.");
    return;
  }

  const nextValue = parseInt(clientAccounts[clientAccounts.length - 1]?.iban?.replace(/\s/g, '').slice(-editableLength), 10) + 1;
  const numStr = nextValue.toString().padStart(editableLength, '0');
  const national = prefix + numStr + suffix;
  const iban = "SA" + national;
  const formattedIban = iban.match(/.{1,4}/g).join(" ");
  const autoId = generateId(clientAccounts.length);

  const item = document.createElement("div");
  item.className = "client-item";
  item.innerHTML = `
    <div><small>${formattedIban}</small></div>
    <input type="text" class="client-name" placeholder="اسم العميل">
    <input type="text" class="amount" placeholder="مبلغ العقار (مثل: ١٠٠٠)">
  `;
  document.getElementById("clientsContainer").appendChild(item);

  clientAccounts.push({
    iban: formattedIban,
    national,
    name: "",
    id: autoId,
    amount: ""
  });
}

function finalizeClients() {
  const items = document.querySelectorAll(".client-item");
  const arToEnMap = { '٠': '
